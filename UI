using UnityEngine;
using UnityEngine.InputSystem;
using UnityEngine.UI;
using UnityEngine.EventSystems;

public class PlayerSc : MonoBehaviour
{
    [Header("Components")]
    [SerializeField] private CharacterController charController;
    [SerializeField] private InputActionAsset inputAction;
    [SerializeField] private Animator animator;

    [Header("Movement Settings")]
    [SerializeField] private float walkSpeed = 5f;
    [SerializeField] private float sprintSpeed = 8f;
    [SerializeField] private float jumpHeight = 2f;
    [SerializeField] private float gravity = 9.8f;
    [SerializeField] private Transform respawnPoint;

    private InputAction move, look, sprint, jump, melee;
    private Vector2 moveInput, lookInput;
    private Vector3 velocity;
    private bool isSprinting;
    private bool hasWon = false;
    private bool isJumping = false;

    [Header("Combat")]
    public Collider handHitbox;

    private bool isGrounded => charController.isGrounded;

    private void OnEnable()
    {
        var map = inputAction.FindActionMap("Player");
        map.Enable();

        move = map.FindAction("Move");
        look = map.FindAction("Look");
        sprint = map.FindAction("Sprint");
        jump = map.FindAction("Jump");
        melee = map.FindAction("Meele");

        // Sprint
        sprint.performed += ctx => { if (!hasWon) isSprinting = true; };
        sprint.canceled += ctx => { if (!hasWon) isSprinting = false; };

        // Jump
        jump.performed += JumpInput;

        // Melee
        melee.performed += MeleeAttack;
    }

    private void Update()
    {
        if (!hasWon)
        {
            HandleMovement();
            HandleRotation();

            if (transform.position.y < -10f)
                Respawn();
        }
    }

    private void HandleMovement()
    {
        // --- READ INPUT FROM NEW SYSTEM ---
        Vector2 newInput = move != null ? move.ReadValue<Vector2>() : Vector2.zero;

        // --- READ INPUT FROM OLD SYSTEM (WASD/Arrow Keys) ---
        Vector2 oldInput = new Vector2(
            Input.GetAxisRaw("Horizontal"),
            Input.GetAxisRaw("Vertical")
        );

        // --- PICK WHICHEVER SYSTEM IS ACTUALLY BEING USED ---
        moveInput = newInput != Vector2.zero ? newInput : oldInput;

        float currentSpeed = isSprinting ? sprintSpeed : walkSpeed;

        Vector3 moveDir = transform.TransformDirection(
            new Vector3(moveInput.x, 0f, moveInput.y)
        ) * currentSpeed;

        // --- GRAVITY & JUMPING ---
        if (isGrounded && velocity.y < 0)
        {
            velocity.y = -1f;        // Keeps grounded
            animator.SetBool("Fall", false);
            isJumping = false;
        }
        else
        {
            velocity.y -= gravity * Time.deltaTime;
            if (velocity.y < -0.1f)
                animator.SetBool("Fall", true);
        }

        // --- APPLY MOVEMENT ---
        Vector3 totalMove = moveDir + new Vector3(0, velocity.y, 0);
        charController.Move(totalMove * Time.deltaTime);

        // --- ANIMATIONS ---
        float forward = moveInput.y;
        animator.SetFloat("Walk", Mathf.Abs(forward));
        animator.SetBool("Run", isSprinting && forward > 0.1f);
    }

    private void HandleRotation()
    {
        // New system
        Vector2 newLook = look != null ? look.ReadValue<Vector2>() : Vector2.zero;

        // Old system
        Vector2 oldLook = new Vector2(
            Input.GetAxis("Mouse X"),
            Input.GetAxis("Mouse Y")
        );

        // Prioritize whichever is active
        lookInput = newLook != Vector2.zero ? newLook : oldLook;

        transform.Rotate(0f, lookInput.x, 0f);
    }

    private void JumpInput(InputAction.CallbackContext context)
    {
        if (hasWon || isJumping || !isGrounded) return;

        isJumping = true;
        velocity.y = Mathf.Sqrt(jumpHeight * 2f * gravity);

        animator.ResetTrigger("Meele");
        animator.SetTrigger("Jump");
        animator.SetBool("Fall", false);
    }

    private void MeleeAttack(InputAction.CallbackContext context)
    {
        if (hasWon || isJumping) return;

        animator.ResetTrigger("Jump");
        animator.ResetTrigger("Meele");
        animator.SetTrigger("Meele");
    }

    private void Respawn()
    {
        velocity = Vector3.zero;
        charController.enabled = false;
        transform.position = respawnPoint.position;
        charController.enabled = true;
    }

    public void Win()
    {
        hasWon = true;
        charController.enabled = false;

        animator.SetFloat("Walk", 0f);
        animator.SetBool("Run", false);
        animator.SetBool("Fall", false);

        animator.ResetTrigger("Jump");
        animator.ResetTrigger("Meele");
        animator.SetTrigger("Win");

        Debug.Log("Win animation triggered!");
    }
}